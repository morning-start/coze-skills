# 工作流模式

## 目录
- [工作流概述](#工作流概述)
- [线性工作流](#线性工作流)
- [分支工作流](#分支工作流)
- [并行工作流](#并行工作流)
- [循环工作流](#循环工作流)
- [混合工作流](#混合工作流)
- [工作流设计原则](#工作流设计原则)

## 概览
本文档定义了标准化的工作流模式，用于编排多个技能完成复杂目标。

## 工作流概述

### 工作流定义
工作流是一系列有序步骤的编排，每个步骤调用特定技能，通过明确的输入输出和数据流转，达成预设目标。

### 核心要素
1. **目标**: 工作流要达成的最终目的
2. **技能**: 完成步骤所需的技能清单
3. **步骤**: 按顺序或条件执行的操作
4. **数据**: 步骤间的数据传递
5. **控制流**: 步骤执行的顺序和条件

### 设计原则
1. **目标明确**: 清晰定义工作流的产出和成功标准
2. **步骤可执行**: 每个步骤都有明确的操作和可验证的输出
3. **容错设计**: 包含异常处理和回退机制
4. **可追踪**: 每个步骤都可监控和审计

## 线性工作流

### 模式定义
步骤按固定顺序依次执行，无分支和循环。

### 适用场景
- 标准化的数据处理流程
- 文档生成流程
- 报告制作流程

### 结构示例
```
目标: 生成数据分析报告

步骤1: 数据获取
  ↓ [原始数据]
步骤2: 数据清洗
  ↓ [清洗后的数据]
步骤3: 数据分析
  ↓ [分析结果]
步骤4: 报告生成
  ↓ [最终报告]
输出: 数据分析报告
```

### WORKFLOW.md 示例
```markdown
---
name: data-analysis-report
description: 生成数据分析报告的标准流程
target: 根据原始数据生成包含统计分析和可视化图表的分析报告
skills_required: [data-fetcher, data-cleaner, data-analyzer, report-generator]
---

## 目标
根据原始数据生成完整的数据分析报告，包含统计摘要、趋势分析和可视化图表。

## 前置条件
- 数据源可访问
- 所需技能已配置
- 输出目录有写入权限

## 技能清单
- data-fetcher: 从数据源获取原始数据
- data-cleaner: 清洗和预处理数据
- data-analyzer: 执行统计分析和计算
- report-generator: 生成格式化的分析报告

## 执行流程

### 步骤 1: 数据获取
- **使用技能**: data-fetcher
- **输入**: 数据源连接信息（URL、认证信息）
- **操作**: 连接数据源，获取原始数据
- **输出**: 原始数据文件（CSV/JSON格式）
- **下一步**: 步骤 2

### 步骤 2: 数据清洗
- **使用技能**: data-cleaner
- **输入**: 步骤1的原始数据文件
- **操作**: 处理缺失值、去重、格式标准化
- **输出**: 清洗后的数据文件
- **下一步**: 步骤 3

### 步骤 3: 数据分析
- **使用技能**: data-analyzer
- **输入**: 步骤2的清洗数据
- **操作**: 执行统计分析、趋势计算、指标提取
- **输出**: 分析结果（统计摘要、图表数据）
- **下一步**: 步骤 4

### 步骤 4: 报告生成
- **使用技能**: report-generator
- **输入**: 步骤3的分析结果
- **操作**: 生成包含图表和文字的分析报告
- **输出**: 最终报告文件（PDF/HTML格式）
- **下一步**: 结束

## 异常处理
- 数据获取失败: 检查网络连接和数据源配置，重试3次后终止
- 数据清洗错误: 记录错误行，继续处理其他数据
- 分析步骤失败: 使用默认统计方法，标记异常

## 输出交付物
- 数据分析报告（PDF/HTML）
- 清洗后的数据文件（CSV）
- 分析日志文件

## 示例
分析销售数据：
1. 从数据库获取过去一年的销售记录
2. 清洗数据（处理缺失的订单金额、标准化日期格式）
3. 分析数据（计算月度销售额、识别趋势、对比同期）
4. 生成报告（包含图表、文字分析、建议）
```

## 分支工作流

### 模式定义
根据条件选择不同的执行路径。

### 适用场景
- 需要根据输入类型选择处理方式
- 多场景适配（不同场景不同流程）
- 质量检查后的分流处理

### 结构示例
```
输入数据
  ↓
步骤1: 数据分类
  ↓
├─ [类型A] → 路径A处理
│              ↓
│           步骤A1 → 步骤A2 → 输出A
│
└─ [类型B] → 路径B处理
               ↓
            步骤B1 → 步骤B2 → 输出B
```

### WORKFLOW.md 示例
```markdown
---
name: content-processing-branched
description: 根据内容类型选择不同处理路径
target: 智能识别内容类型并应用相应的处理流程
skills_required: [content-classifier, text-processor, image-processor, video-processor]
---

## 目标
根据输入内容的类型（文本、图片、视频），自动选择对应的处理流程进行处理。

## 前置条件
- 输入内容可访问
- 所有处理器可用

## 执行流程

### 步骤 1: 内容分类
- **使用技能**: content-classifier
- **输入**: 待处理内容
- **操作**: 识别内容类型（text/image/video）
- **输出**: 内容类型标签
- **下一步**: 根据类型选择分支

### 分支 A: 文本处理（类型=text）
#### 步骤 A1: 文本提取
- **使用技能**: text-processor
- **输入**: 原始文本
- **操作**: 提取关键信息、情感分析
- **输出**: 结构化文本数据
- **下一步**: 步骤 A2

#### 步骤 A2: 文本优化
- **使用技能**: text-processor
- **输入**: 结构化文本数据
- **操作**: 格式化、摘要生成
- **输出**: 优化后的文本
- **下一步**: 结束

### 分支 B: 图片处理（类型=image）
#### 步骤 B1: 图片分析
- **使用技能**: image-processor
- **输入**: 原始图片
- **操作**: 识别内容、提取特征
- **输出**: 图片分析结果
- **下一步**: 步骤 B2

#### 步骤 B2: 图片优化
- **使用技能**: image-processor
- **输入**: 原始图片和分析结果
- **操作**: 调整尺寸、压缩、增强
- **输出**: 优化后的图片
- **下一步**: 结束

## 异常处理
- 无法识别类型: 默认使用文本处理流程，记录异常
- 处理器不可用: 跳过该分支，记录错误，继续其他分支
```

## 并行工作流

### 模式定义
多个步骤同时执行，结果合并。

### 适用场景
- 多维度同时处理
- 批量独立任务
- 性能优化（缩短总时间）

### 结构示例
```
输入数据
  ↓
步骤1: 数据分发
  ↓
├─→ 并行处理 A
│     ↓
│   [结果A]
│
├─→ 并行处理 B
│     ↓
│   [结果B]
│
└─→ 并行处理 C
      ↓
    [结果C]
      ↓
步骤5: 结果合并
  ↓
输出
```

### WORKFLOW.md 示例
```markdown
---
name: multi-dimension-analysis
description: 多维度并行分析流程
target: 同时从多个维度分析数据，合并生成综合分析报告
skills_required: [data-distributor, sentiment-analyzer, trend-analyzer, quality-analyzer, result-merger]
---

## 目标
对同一批数据进行情感分析、趋势分析和质量分析，合并结果生成综合报告。

## 执行流程

### 步骤 1: 数据分发
- **使用技能**: data-distributor
- **输入**: 原始数据集
- **操作**: 复制数据到三个处理队列
- **输出**: 三个相同的数据副本
- **下一步**: 并行步骤 2A、2B、2C

### 步骤 2A: 情感分析（并行）
- **使用技能**: sentiment-analyzer
- **输入**: 数据副本A
- **操作**: 分析文本情感倾向
- **输出**: 情感分析结果
- **下一步**: 步骤 3

### 步骤 2B: 趋势分析（并行）
- **使用技能**: trend-analyzer
- **输入**: 数据副本B
- **操作**: 识别时间序列趋势
- **输出**: 趋势分析结果
- **下一步**: 步骤 3

### 步骤 2C: 质量分析（并行）
- **使用技能**: quality-analyzer
- **输入**: 数据副本C
- **操作**: 评估数据质量指标
- **输出**: 质量评分报告
- **下一步**: 步骤 3

### 步骤 3: 结果合并
- **使用技能**: result-merger
- **输入**: 情感分析结果、趋势分析结果、质量评分报告
- **操作**: 合并三个维度的分析结果
- **输出**: 综合分析报告
- **下一步**: 结束

## 异常处理
- 某并行步骤失败: 使用默认值继续，标记该维度数据缺失
- 结果合并失败: 返回部分成功的结果，记录错误
```

## 循环工作流

### 模式定义
包含重复执行或迭代的步骤。

### 适用场景
- 批量处理（逐个处理列表中的项）
- 迭代优化（反复改进直到满足条件）
- 分页处理（处理大量数据的分页）

### 结构示例
```
输入: 待处理列表
  ↓
步骤1: 获取下一项
  ↓
├─ [有数据] → 步骤2: 处理数据
│               ↓
│            [处理完成]
│               ↓
│            返回步骤1
│
└─ [无数据] → 步骤3: 汇总结果
               ↓
             输出
```

### WORKFLOW.md 示例
```markdown
---
name: batch-document-processing
description: 批量文档处理流程
target: 逐个处理文档列表中的每个文档，最后汇总处理结果
skills_required: [list-manager, document-processor, result-aggregator]
---

## 目标
批量处理多个文档，对每个文档执行相同的处理流程，最后汇总所有处理结果。

## 执行流程

### 步骤 1: 初始化
- **使用技能**: list-manager
- **输入**: 文档列表
- **操作**: 初始化处理状态，设置计数器
- **输出**: 待处理队列
- **下一步**: 步骤 2

### 步骤 2: 检查队列（循环起点）
- **使用技能**: list-manager
- **输入**: 待处理队列
- **操作**: 检查是否还有未处理的文档
- **输出**: 下一项文档或空
- **下一步**: 如有数据→步骤3；如无→步骤5

### 步骤 3: 处理文档（循环体）
- **使用技能**: document-processor
- **输入**: 当前文档
- **操作**: 执行文档处理（解析、提取、转换）
- **输出**: 处理结果
- **下一步**: 步骤 4

### 步骤 4: 保存结果
- **使用技能**: list-manager
- **输入**: 处理结果
- **操作**: 保存结果到结果列表，更新计数器
- **输出**: 更新后的结果列表
- **下一步**: 返回步骤 2（继续循环）

### 步骤 5: 汇总结果（循环结束）
- **使用技能**: result-aggregator
- **输入**: 所有处理结果
- **操作**: 统计处理数量、成功率、生成汇总报告
- **输出**: 最终汇总报告
- **下一步**: 结束

## 异常处理
- 单个文档处理失败: 记录错误，继续处理下一个，不影响整体流程
- 循环超时: 强制退出循环，返回已处理的结果
```

## 混合工作流

### 模式定义
组合多种模式（线性+分支+并行+循环）的复杂工作流。

### 适用场景
- 复杂业务场景
- 端到端自动化流程
- 多阶段处理流程

### 结构示例
```
输入
  ↓
步骤1: 预处理
  ↓
步骤2: 分类（分支）
  ↓
├─ [类型A] → 并行处理A1、A2
│             ↓
│           合并 → 步骤3
│
└─ [类型B] → 循环处理（批量）
               ↓
             汇总 → 步骤3

步骤3: 最终整合
  ↓
输出
```

### 设计建议
1. **模块化设计**: 将复杂流程拆分为子流程
2. **清晰的控制流**: 使用明确的条件判断和跳转
3. **状态追踪**: 记录每个步骤的状态和输出
4. **分层文档**: 主流程简述，子流程详述

## 工作流设计原则

### 步骤设计原则
1. **原子性**: 每个步骤只做一件事
2. **可验证**: 每个步骤有明确的完成标准
3. **独立性**: 步骤间通过明确的接口交互
4. **幂等性**: 重复执行步骤结果一致

### 数据流转原则
1. **格式统一**: 定义标准的数据格式
2. **最小传递**: 只传递必要的数据
3. **版本兼容**: 考虑数据格式的演进
4. **可追溯**: 记录数据的来源和转换历史

### 异常处理原则
1. **快速失败**: 尽早发现问题
2. **优雅降级**: 部分失败时提供备选方案
3. **详细记录**: 记录异常信息和处理过程
4. **可恢复**: 支持从异常点恢复执行

### 检查清单
- [ ] 目标清晰明确
- [ ] 技能清单完整
- [ ] 每个步骤定义完整（技能、输入、操作、输出、下一步）
- [ ] 异常处理机制完善
- [ ] 输出交付物明确
- [ ] 示例具有代表性
