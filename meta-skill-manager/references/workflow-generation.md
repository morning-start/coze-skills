# 工作流生成

## 目录
- [概述](#概述)
- [工作流模式](#工作流模式)
- [生成流程](#生成流程)
- [WORKFLOW.md 结构](#workflowmd-结构)
- [步骤设计](#步骤设计)
- [异常处理](#异常处理)
- [最佳实践](#最佳实践)

## 概述
工作流生成是将多个技能编排为标准化流程文档，实现复杂目标自动化的过程。

### 工作流定义
工作流是一系列有序步骤的编排，每个步骤调用特定技能，通过明确的输入输出和数据流转，达成预设目标。

### 核心要素
1. **目标**: 工作流要达成的最终目的
2. **技能**: 完成步骤所需的技能清单
3. **步骤**: 按顺序或条件执行的操作
4. **数据**: 步骤间的数据传递
5. **控制流**: 步骤执行的顺序和条件

### 适用场景
- 需要编排多个技能完成特定目标
- 需要标准化操作流程
- 需要自动化复杂任务
- 需要多人协作的流程指导

## 工作流模式

### 模式选择

| 模式 | 执行方式 | 适用场景 | 复杂度 |
|------|---------|---------|--------|
| 线性 | 顺序执行 | 标准化流程 | 低 |
| 分支 | 条件选择 | 多场景处理 | 中 |
| 并行 | 同时执行 | 多维度处理 | 中 |
| 循环 | 重复执行 | 批量处理 | 中 |
| 混合 | 组合多种 | 复杂业务 | 高 |

### 线性工作流

**定义**: 步骤按固定顺序依次执行，无分支和循环。

**结构**:
```
输入 → 步骤1 → 步骤2 → 步骤3 → 输出
```

**适用场景**:
- 标准化的数据处理流程
- 文档生成流程
- 报告制作流程

**示例**: 数据分析报告生成
```
原始数据 → 数据获取 → 数据清洗 → 数据分析 → 报告生成 → 最终报告
```

### 分支工作流

**定义**: 根据条件选择不同的执行路径。

**结构**:
```
输入 → 条件判断
         ├─ [条件A] → 路径A → 输出A
         └─ [条件B] → 路径B → 输出B
```

**适用场景**:
- 需要根据输入类型选择处理方式
- 多场景适配
- 质量检查后的分流处理

**示例**: 内容分类处理
```
输入内容 → 内容分类
             ├─ [文本] → 文本处理 → 输出
             ├─ [图片] → 图片处理 → 输出
             └─ [视频] → 视频处理 → 输出
```

### 并行工作流

**定义**: 多个步骤同时执行，结果合并。

**结构**:
```
输入 → 分发
       ├─→ 步骤A ─┐
       ├─→ 步骤B ─┼→ 合并 → 输出
       └─→ 步骤C ─┘
```

**适用场景**:
- 多维度同时处理
- 批量独立任务
- 性能优化

**示例**: 多维度内容分析
```
输入内容 → 并行分发
           ├─→ 情感分析 ─┐
           ├─→ 主题分析 ─┼→ 合并结果 → 综合分析报告
           └─→ 关键词提取─┘
```

### 循环工作流

**定义**: 包含重复执行或迭代的步骤。

**结构**:
```
输入列表 → 获取下一项 → 有数据？
                         ├─ 是 → 处理 → 保存结果 → 返回
                         └─ 否 → 汇总 → 输出
```

**适用场景**:
- 批量处理列表中的项
- 迭代优化直到满足条件
- 分页处理大量数据

**示例**: 批量文档处理
```
文档列表 → 读取文档 → 处理 → 保存结果 → 还有文档？
                                         ├─ 是 → 继续
                                         └─ 否 → 汇总报告
```

### 混合工作流

**定义**: 组合多种模式的复杂工作流。

**结构**:
```
输入 → 预处理 → 条件分支 → 并行处理 → 循环迭代 → 汇总 → 输出
```

**适用场景**:
- 复杂业务场景
- 端到端自动化流程
- 多阶段处理流程

**示例**: 综合数据处理
```
原始数据 → 预处理
            ↓
         分类判断
            ├─ [类型A] → 并行分析（维度1、维度2）→ 汇总
            └─ [类型B] → 批量处理（循环）→ 汇总
                           ↓
                        最终报告
```

## 生成流程

### 流程概览
```
理解目标 → 分析技能 → 选择模式 → 设计流程 → 生成文档
```

### 详细步骤

#### 步骤 1: 理解目标

**1.1 明确工作流目标**
- 最终要达成什么结果？
- 输出是什么？（报告、数据、文件等）
- 成功标准是什么？

**1.2 识别输入和约束**
- 输入数据/资源是什么？
- 有什么约束条件？（时间、资源、质量）
- 前置条件是什么？

**1.3 定义交付物**
- 主要交付物
- 中间产物
- 元数据和日志

**目标定义示例**:
```
目标: 生成市场分析报告
输入: 销售数据、市场数据、客户数据
输出: PDF 格式的市场分析报告
约束: 处理时间 < 30分钟，数据量 < 100万条
交付物:
  - 主要: 市场分析报告（PDF）
  - 中间: 清洗后的数据、分析结果
  - 元数据: 处理日志、质量评分
```

#### 步骤 2: 分析技能

**2.1 列出可用技能**

识别所有可用技能及其能力：
```
可用技能:
  - data-fetcher: 数据获取
  - data-cleaner: 数据清洗
  - data-analyzer: 数据分析
  - report-generator: 报告生成
  - visualizer: 数据可视化
```

**2.2 匹配技能与目标**

分析每个技能对工作流的贡献：
| 技能 | 能力 | 对工作流的贡献 |
|------|------|--------------|
| data-fetcher | 数据获取 | 获取原始数据 |
| data-cleaner | 数据清洗 | 预处理数据 |
| data-analyzer | 数据分析 | 生成洞察 |
| report-generator | 报告生成 | 输出最终报告 |

**2.3 识别技能依赖**

确定技能间的依赖关系：
```
data-fetcher → data-cleaner（依赖：清洗需要数据源）
data-cleaner → data-analyzer（依赖：分析需要清洗后数据）
data-analyzer → report-generator（依赖：报告需要分析结果）
```

**2.4 评估技能缺口**

检查是否有缺失的能力：
- [x] 数据获取: 有 data-fetcher
- [x] 数据清洗: 有 data-cleaner
- [x] 数据分析: 有 data-analyzer
- [x] 报告生成: 有 report-generator
- [ ] 数据验证: 无（可能需要创建或使用 data-cleaner 的验证功能）

#### 步骤 3: 选择工作流模式

**3.1 评估场景特征**

根据以下特征选择模式：
- 是否需要条件分支？
- 是否有独立可并行的步骤？
- 是否需要重复处理？
- 复杂度如何？

**3.2 选择合适模式**

选择逻辑：
```
if 有明确条件分支:
  选择分支模式
elif 有独立可并行步骤:
  选择并行模式
elif 需要重复处理:
  选择循环模式
elif 以上多种:
  选择混合模式
else:
  选择线性模式（默认）
```

**3.3 确定模式变体**

对选定模式进行细化：
- 分支模式：确定分支条件和路径
- 并行模式：确定并行步骤和合并策略
- 循环模式：确定循环条件和退出条件

#### 步骤 4: 设计流程

**4.1 编排步骤顺序**

根据技能依赖确定执行顺序：
```
步骤1: data-fetcher（获取数据）
步骤2: data-cleaner（清洗数据）
步骤3: data-analyzer（分析数据）
步骤4: report-generator（生成报告）
```

**4.2 设计数据流转**

定义每个步骤的输入输出：
```
步骤1输出: {raw_data: [...], metadata: {...}}
步骤2输入: {raw_data: [...], cleaning_rules: {...}}
步骤2输出: {cleaned_data: [...], report: {...}}
步骤3输入: {cleaned_data: [...], analysis_params: {...}}
步骤3输出: {analysis_results: {...}, charts: [...]}
步骤4输入: {analysis_results: {...}, template: "..."}
步骤4输出: {report_file: "...", format: "pdf"}
```

**4.3 定义控制流**

确定步骤间的控制关系：
- 顺序执行：步骤1 → 步骤2 → 步骤3
- 条件分支：if 数据量 > 100万 then 使用批处理
- 并行执行：步骤A 和 步骤B 同时执行
- 循环执行：while 还有文档 do 处理

**4.4 设计异常处理**

识别可能的异常和应对策略：
| 步骤 | 可能的异常 | 处理策略 |
|------|-----------|---------|
| 数据获取 | 网络失败 | 重试3次，失败后终止 |
| 数据清洗 | 格式错误 | 记录错误行，继续处理 |
| 数据分析 | 数据不足 | 使用默认统计值，标记异常 |
| 报告生成 | 模板缺失 | 使用默认模板 |

#### 步骤 5: 生成文档

**5.1 编写 WORKFLOW.md 前言**

```yaml
---
name: market-analysis-workflow
description: 市场分析报告生成工作流，整合数据获取、清洗、分析和报告生成
target: 根据销售和市场数据生成完整的市场分析报告
skills_required: [data-fetcher, data-cleaner, data-analyzer, report-generator]
metadata:
  estimated_time: "30分钟"
  complexity: "中等"
  version: "1.0.0"
---
```

**5.2 编写正文各章节**

按照标准结构编写：
1. 目标
2. 前置条件
3. 技能清单
4. 执行流程（详细步骤）
5. 异常处理
6. 输出交付物
7. 示例

**5.3 详细设计每个步骤**

每个步骤包含：
- 步骤名称
- 使用技能
- 输入描述
- 操作说明
- 输出描述
- 下一步

## WORKFLOW.md 结构

### 标准模板

```markdown
---
name: <workflow-name>
description: <工作流描述>
target: <目标说明>
skills_required: [skill-1, skill-2, skill-3]
metadata:
  version: "1.0.0"
  estimated_time: "预计执行时间"
  complexity: "简单/中等/复杂"
  tags: [标签列表]
---

# <工作流名称>

## 目标
<详细描述工作流要达成的目标>
<说明成功标准和验收条件>

## 前置条件
- <条件1：环境、权限、资源>
- <条件2：数据准备>
- <条件3：技能配置>

## 技能清单
- <skill-1>: <用途说明，在这个工作流中承担什么角色>
- <skill-2>: <用途说明>
- <skill-3>: <用途说明>

## 执行流程

### 步骤 1: <步骤名称>
- **使用技能**: <skill-name>
- **输入**: <输入描述，包括数据来源、格式、必需字段>
- **操作**: <具体操作说明，做什么、怎么做>
- **输出**: <输出描述，包括格式、字段说明>
- **下一步**: <下一步骤名称或"结束">

### 步骤 2: <步骤名称>
- **使用技能**: <skill-name>
- **输入**: <输入描述>
- **操作**: <具体操作说明>
- **输出**: <输出描述>
- **下一步**: <下一步骤名称或"结束">

## 数据流转
<说明步骤间的数据传递>
- 步骤1.output → 步骤2.input（格式转换说明）
- 步骤2.output → 步骤3.input（格式转换说明）

## 异常处理
- <异常情况1>: <处理方式，包括重试、回退、终止>
- <异常情况2>: <处理方式>

## 输出交付物
- <交付物1>: <描述、格式、位置>
- <交付物2>: <描述、格式、位置>
- <元数据>: <日志、报告等>

## 示例
<完整示例说明>
<输入数据示例>
<执行过程示例>
<输出结果示例>
```

## 步骤设计

### 步骤设计原则

1. **原子性**: 每个步骤只做一件事
2. **可验证**: 有明确的完成标准
3. **独立性**: 通过接口与其他步骤交互
4. **幂等性**: 重复执行结果一致

### 步骤信息规范

每个步骤必须包含：

**使用技能**
- 明确调用哪个技能
- 说明使用的具体能力

**输入**
- 数据来源（上一步输出/外部输入）
- 数据格式（JSON/CSV/文本等）
- 必需字段和可选字段
- 数据示例

**操作**
- 具体操作说明
- 参数配置
- 执行条件

**输出**
- 输出格式
- 字段说明
- 成功/失败判定

**下一步**
- 明确指向下一步
- 说明流转条件（如适用）

### 步骤示例

**完整步骤示例**:
```markdown
### 步骤 2: 数据清洗
- **使用技能**: data-cleaner
- **输入**: 
  - 来源: 步骤1的输出
  - 格式: JSON
  - 必需字段:
    - raw_data: "原始数据数组"
    - data_type: "数据类型标识"
  - 可选字段:
    - cleaning_level: "清洗级别（basic/standard/advanced）"
      默认值: "standard"
- **操作**: 
  1. 接收原始数据
  2. 根据 cleaning_level 执行对应清洗规则
  3. 处理缺失值（根据策略：drop/fill/mean）
  4. 去除重复数据
  5. 标准化数据格式
  6. 生成清洗报告
- **输出**: 
  - 格式: JSON
  - 字段:
    - cleaned_data: "清洗后的数据数组"
    - cleaning_report:
      - original_count: "原始记录数"
      - cleaned_count: "清洗后记录数"
      - removed_duplicates: "去重数量"
      - quality_score: "质量评分（0-100）"
- **下一步**: 步骤 3（数据分析）
  - 条件: 如果 quality_score < 50，返回步骤1重新获取数据
```

## 异常处理

### 异常分类

| 类别 | 说明 | 处理策略 |
|------|------|---------|
| 可恢复 | 临时性问题，可重试 | 重试机制 |
| 可降级 | 部分失败，可继续 | 使用默认值/备选方案 |
| 致命 | 无法继续，必须终止 | 记录错误，优雅退出 |

### 异常处理设计

**重试机制**:
```
步骤执行失败
  ├─ 重试次数 < 3？
  │   ├─ 是 → 等待 5秒 → 重试
  │   └─ 否 → 进入降级/终止
```

**降级策略**:
```
步骤执行失败
  ├─ 有备选方案？
  │   ├─ 是 → 使用备选方案 → 标记降级 → 继续
  │   └─ 否 → 使用默认值 → 标记数据缺失 → 继续
```

**终止策略**:
```
步骤执行失败
  ├─ 是关键步骤？
  │   ├─ 是 → 记录错误 → 保存中间结果 → 终止工作流
  │   └─ 否 → 记录错误 → 继续（跳过此步骤）
```

### 异常处理示例

```markdown
## 异常处理

### 步骤1（数据获取）异常
- **网络失败**: 重试3次，间隔5秒；仍失败则终止工作流
- **权限不足**: 记录错误，提示检查权限配置，终止工作流
- **数据源不存在**: 记录错误，提示检查数据源配置，终止工作流

### 步骤2（数据清洗）异常
- **格式错误**: 记录错误行号，跳过错误行，继续处理其他数据
- **数据为空**: 记录警告，返回空结果，继续下一步（需下游处理）
- **清洗规则不匹配**: 使用默认规则，记录警告，继续

### 步骤3（数据分析）异常
- **数据量不足**: 使用默认统计值，标记"数据不足"，继续
- **算法失败**: 使用简化算法，记录降级信息，继续
- **超时**: 中断分析，返回部分结果，继续

### 步骤4（报告生成）异常
- **模板缺失**: 使用默认模板，记录警告，继续
- **图表生成失败**: 跳过图表，生成纯文本报告，记录警告，继续
- **导出失败**: 尝试其他格式，记录警告，继续
```

## 最佳实践

### 设计阶段
- **目标明确**: 清晰定义工作流的目标和成功标准
- **范围控制**: 一个工作流聚焦一个核心目标
- **技能复用**: 优先使用现有技能，减少重复开发
- **流程简化**: 去除不必要的步骤，保持流程简洁

### 文档编写
- **结构清晰**: 使用标准模板，保持一致性
- **信息完整**: 每个步骤包含完整信息（技能、输入、操作、输出、下一步）
- **示例丰富**: 提供完整的示例，包括输入、过程、输出
- **异常覆盖**: 考虑各种异常情况，设计处理策略

### 验证测试
- **流程验证**: 验证步骤顺序和数据流转
- **异常测试**: 测试各种异常情况的处理
- **边界测试**: 测试边界条件（空数据、大数据量）
- **示例验证**: 按照示例实际执行，验证可行性

### 持续优化
- **收集反馈**: 收集用户反馈，识别问题
- **监控执行**: 监控工作流执行情况和性能
- **迭代优化**: 根据反馈和监控结果持续优化

### 检查清单
- [ ] 目标清晰，成功标准明确
- [ ] 技能清单完整，能力匹配
- [ ] 步骤顺序合理，数据流转清晰
- [ ] 每个步骤信息完整（技能、输入、操作、输出、下一步）
- [ ] 异常处理完善，覆盖主要异常情况
- [ ] 输出交付物明确
- [ ] 示例完整，可执行
- [ ] 文档符合标准格式
