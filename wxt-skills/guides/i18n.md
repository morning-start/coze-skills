# 国际化配置

本文档详细说明如何在 WXT 扩展中配置和使用国际化（i18n），包括多语言支持、动态切换、格式化和最佳实践。

## 官方导航链接

- [I18n](https://wxt.dev/guide/essentials/i18n.html) - 国际化完整指南

---

## 一、国际化概述

### 1.1 什么是 i18n

国际化（Internationalization，简称 i18n）是指让扩展能够支持多种语言和地区，无需修改代码即可适应不同的语言环境。

### 1.2 WXT i18n 特性

- 自动加载语言文件
- 运行时语言切换
- 占位符替换
- 复数形式支持
- 变量插值

## 二、语言文件

### 2.1 目录结构

```
my-extension/
├── public/
│   └── _locales/          # 国际化文件根目录
│       ├── en/             # 英语
│       │   └── messages.json
│       ├── zh_CN/          # 简体中文
│       │   └── messages.json
│       ├── zh_TW/          # 繁体中文
│       │   └── messages.json
│       ├── ja/             # 日语
│       │   └── messages.json
│       └── ko/             # 韩语
│           └── messages.json
```

### 2.2 消息文件格式

```json
// public/_locales/en/messages.json
{
  "appName": {
    "message": "My Extension",
    "description": "The name of the extension"
  },
  "appDescription": {
    "message": "A sample extension demonstrating i18n",
    "description": "The description of the extension"
  },
  "hello": {
    "message": "Hello, World!",
    "description": "A greeting message"
  },
  "greeting": {
    "message": "Hello, {name}!",
    "description": "A personalized greeting",
    "placeholders": {
      "name": {
        "content": "$1",
        "example": "John"
      }
    }
  },
  "itemCount": {
    "message": "You have {count} items",
    "description": "Number of items",
    "placeholders": {
      "count": {
        "content": "$1",
        "example": "5"
      }
    }
  },
  "items": {
    "message": "{count, plural, =1{1 item} other{# items}}",
    "description": "Items with plural form",
    "placeholders": {
      "count": {
        "content": "$1",
        "example": "5"
      }
    }
  }
}
```

```json
// public/_locales/zh_CN/messages.json
{
  "appName": {
    "message": "我的扩展",
    "description": "扩展名称"
  },
  "appDescription": {
    "message": "一个演示国际化的示例扩展",
    "description": "扩展描述"
  },
  "hello": {
    "message": "你好，世界！",
    "description": "问候消息"
  },
  "greeting": {
    "message": "你好，{name}！",
    "description": "个性化问候",
    "placeholders": {
      "name": {
        "content": "$1",
        "example": "张三"
      }
    }
  },
  "itemCount": {
    "message": "你有 {count} 个项目",
    "description": "项目数量",
    "placeholders": {
      "count": {
        "content": "$1",
        "example": "5"
      }
    }
  },
  "items": {
    "message": "{count, plural, =1{1 个项目} other{# 个项目}}",
    "description": "带有复数形式的项目",
    "placeholders": {
      "count": {
        "content": "$1",
        "example": "5"
      }
    }
  }
}
```

## 三、在 Manifest 中使用

### 3.1 配置 Manifest

```typescript
// wxt.config.ts
export default defineConfig({
  manifest: {
    name: '__MSG_appName__',
    description: '__MSG_appDescription__',
    default_locale: 'en',
  },
});
```

### 3.2 默认语言

`default_locale` 指定扩展的默认语言，当用户的浏览器语言不在支持列表中时使用。

## 四、在 JavaScript 中使用

### 4.1 获取消息

```typescript
// 获取单个消息
const appName = browser.i18n.getMessage('appName');
console.log(appName); // "My Extension" 或 "我的扩展"

// 获取带占位符的消息
const greeting = browser.i18n.getMessage('greeting', 'John');
console.log(greeting); // "Hello, John!" 或 "你好，John！"

// 获取复数形式
const items = browser.i18n.getMessage('items', '5');
console.log(items); // "5 items" 或 "5 个项目"
```

### 4.2 检测语言

```typescript
// 获取浏览器语言
const language = browser.i18n.getUILanguage();
console.log(language); // "en-US", "zh-CN", "ja-JP"

// 获取接受语言列表
const acceptLanguages = browser.i18n.getAcceptLanguages();
console.log(acceptLanguages); // ["zh-CN", "zh", "en-US", "en"]
```

### 4.3 获取所有消息

```typescript
// 获取当前语言的所有消息
const messages = browser.i18n.getMessage('');
console.log(messages); // Object with all messages

// 检查消息是否存在
const hasMessage = browser.i18n.getMessage('nonexistent') === '';
console.log(hasMessage); // false
```

## 五、在 HTML 中使用

### 5.1 在 HTML 中使用消息

```html
<!-- popup.html -->
<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
</head>
<body>
  <h1 data-i18n="appName"></h1>
  <p data-i18n="appDescription"></p>
  <button data-i18n="hello"></button>
</body>
</html>
```

### 5.2 在 JavaScript 中替换 HTML

```typescript
// main.ts
function translatePage() {
  const elements = document.querySelectorAll('[data-i18n]');

  elements.forEach((element) => {
    const key = element.getAttribute('data-i18n');
    const message = browser.i18n.getMessage(key);

    if (message) {
      element.textContent = message;
    }
  });
}

// 页面加载后翻译
document.addEventListener('DOMContentLoaded', translatePage);
```

### 5.3 在 Vue 中使用

```vue
<template>
  <h1>{{ $t('appName') }}</h1>
  <p>{{ $t('greeting', { name: userName }) }}</p>
</template>

<script setup>
import { computed, onMounted } from 'vue';

const userName = ref('John');

// 翻译函数
function $t(key, substitutions?) {
  return browser.i18n.getMessage(key, substitutions);
}

// 语言切换
const language = ref(browser.i18n.getUILanguage());

async function switchLanguage(newLanguage) {
  // 更新语言（需要重新加载扩展）
  await browser.storage.local.set({ language: newLanguage });
  browser.runtime.reload();
}
</script>
```

### 5.4 在 Svelte 中使用

```svelte
<script>
  import { onMount } from 'svelte';

  let language = $state(browser.i18n.getUILanguage());

  function $t(key, substitutions) {
    return browser.i18n.getMessage(key, substitutions);
  }
</script>

<h1>{$t('appName')}</h1>
<p>{$t('greeting', { name: 'John' })}</p>
```

## 六、动态语言切换

### 6.1 存储语言设置

```typescript
// utils/i18n.ts
import { storage } from 'wxt/utils/storage';

export const userLanguage = storage.defineItem('local:userLanguage', {
  defaultValue: null,
});

export async function getLanguage() {
  const saved = await userLanguage.getValue();
  return saved || browser.i18n.getUILanguage();
}

export async function setLanguage(language) {
  await userLanguage.setValue(language);
  // 提示用户刷新扩展
  alert('Please reload the extension to apply the language change');
}
```

### 6.2 应用语言设置

```typescript
// entrypoints/background.ts
import { getLanguage } from '~/utils/i18n';

export default defineBackground(async () => {
  const language = await getLanguage();
  console.log('Current language:', language);

  // 可以根据语言加载不同的资源
  if (language.startsWith('zh')) {
    loadChineseResources();
  } else {
    loadEnglishResources();
  }
});
```

### 6.3 语言切换 UI

```typescript
// entrypoints/popup/main.ts
import { setLanguage } from '~/utils/i18n';

const languages = [
  { code: 'en', name: 'English' },
  { code: 'zh_CN', name: '简体中文' },
  { code: 'ja', name: '日本語' },
];

function createLanguageSelector() {
  const select = document.createElement('select');

  languages.forEach(({ code, name }) => {
    const option = document.createElement('option');
    option.value = code;
    option.textContent = name;
    select.appendChild(option);
  });

  select.addEventListener('change', async (e) => {
    const language = e.target.value;
    await setLanguage(language);
  });

  return select;
}

document.body.appendChild(createLanguageSelector());
```

## 七、复数形式

### 7.1 基本复数形式

```json
// en/messages.json
{
  "items": {
    "message": "{count, plural, =0{No items} =1{1 item} other{# items}}",
    "placeholders": {
      "count": {
        "content": "$1",
        "example": "5"
      }
    }
  }
}
```

```json
// zh_CN/messages.json
{
  "items": {
    "message": "{count, plural, =0{没有项目} =1{1 个项目} other{# 个项目}}",
    "placeholders": {
      "count": {
        "content": "$1",
        "example": "5"
      }
    }
  }
}
```

### 7.2 使用复数形式

```typescript
const items0 = browser.i18n.getMessage('items', '0'); // "No items"
const items1 = browser.i18n.getMessage('items', '1'); // "1 item"
const items5 = browser.i18n.getMessage('items', '5'); // "5 items"
```

## 八、变量插值

### 8.1 单个变量

```json
{
  "greeting": {
    "message": "Hello, {name}!",
    "placeholders": {
      "name": {
        "content": "$1",
        "example": "John"
      }
    }
  }
}
```

### 8.2 多个变量

```json
{
  "welcome": {
    "message": "Welcome, {name}! You have {count} new messages.",
    "placeholders": {
      "name": {
        "content": "$1",
        "example": "John"
      },
      "count": {
        "content": "$2",
        "example": "5"
      }
    }
  }
}
```

```typescript
const message = browser.i18n.getMessage('welcome', ['John', '5']);
// "Welcome, John! You have 5 new messages."
```

## 九、最佳实践

### 9.1 消息命名规范

```json
{
  "extension_name": {
    "message": "My Extension",
    "description": "Extension name"
  },
  "button_save": {
    "message": "Save",
    "description": "Save button label"
  },
  "error_network": {
    "message": "Network error",
    "description": "Error message for network issues"
  }
}
```

**命名规则：**
- 使用小写字母和下划线
- 使用前缀区分模块（button_, error_, etc.）
- 提供描述性的 description

### 9.2 完整翻译

```typescript
// 检查翻译完整性
async function checkTranslations() {
  const languages = ['en', 'zh_CN', 'ja'];
  const baseMessages = await loadMessages('en');
  const missingMessages = [];

  for (const language of languages) {
    const messages = await loadMessages(language);

    for (const key of Object.keys(baseMessages)) {
      if (!messages[key]) {
        missingMessages.push({ language, key });
      }
    }
  }

  console.log('Missing translations:', missingMessages);
}
```

### 9.3 日期和数字格式化

```typescript
// 使用 Intl API 格式化日期
function formatDate(date, language) {
  return new Intl.DateTimeFormat(language, {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
}

const language = browser.i18n.getUILanguage();
const formattedDate = formatDate(new Date(), language);

// 使用 Intl API 格式化数字
function formatNumber(number, language) {
  return new Intl.NumberFormat(language).format(number);
}

const formattedNumber = formatNumber(1234567.89, language);
```

### 9.4 语言文件验证

```typescript
// utils/i18n-validator.ts
export function validateMessages(messages) {
  const errors = [];

  for (const [key, value] of Object.entries(messages)) {
    if (!value.message) {
      errors.push(`${key}: missing "message" field`);
    }

    if (!value.description) {
      errors.push(`${key}: missing "description" field`);
    }

    // 验证占位符
    if (value.placeholders) {
      for (const [name, placeholder] of Object.entries(value.placeholders)) {
        if (!placeholder.content) {
          errors.push(`${key}.${name}: missing "content" field`);
        }
      }
    }
  }

  return errors;
}
```

## 十、完整示例

```typescript
// utils/i18n.ts
import { storage } from 'wxt/utils/storage';

export const userLanguage = storage.defineItem('local:userLanguage', {
  defaultValue: null,
});

// 翻译函数
export function $t(key, substitutions?) {
  return browser.i18n.getMessage(key, substitutions);
}

// 获取当前语言
export async function getCurrentLanguage() {
  const saved = await userLanguage.getValue();
  return saved || browser.i18n.getUILanguage();
}

// 设置语言
export async function setLanguage(language) {
  await userLanguage.setValue(language);
  browser.runtime.reload();
}

// 格式化日期
export function formatDate(date, language?) {
  const lang = language || browser.i18n.getUILanguage();
  return new Intl.DateTimeFormat(lang, {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(date);
}

// 格式化数字
export function formatNumber(number, language?) {
  const lang = language || browser.i18n.getUILanguage();
  return new Intl.NumberFormat(lang).format(number);
}

// 组件中使用
export function createI18nMixin() {
  return {
    data() {
      return {
        language: browser.i18n.getUILanguage(),
      };
    },
    methods: {
      $t(key, substitutions?) {
        return $t(key, substitutions);
      },
    },
  };
}
```

```vue
<!-- entrypoints/popup/App.vue -->
<template>
  <div class="app">
    <h1>{{ $t('appName') }}</h1>
    <p>{{ $t('appDescription') }}</p>

    <div class="settings">
      <label>
        Language:
        <select @change="changeLanguage">
          <option value="en">English</option>
          <option value="zh_CN">简体中文</option>
          <option value="ja">日本語</option>
        </select>
      </label>
    </div>

    <div class="content">
      <p>{{ $t('greeting', { name: userName }) }}</p>
      <p>{{ $t('items', '5') }}</p>
    </div>
  </div>
</template>

<script setup>
import { getCurrentLanguage, setLanguage } from '~/utils/i18n';

const userName = ref('John');
const language = ref(await getCurrentLanguage());

async function changeLanguage(e) {
  await setLanguage(e.target.value);
}

function $t(key, substitutions?) {
  return browser.i18n.getMessage(key, substitutions);
}
</script>
```
